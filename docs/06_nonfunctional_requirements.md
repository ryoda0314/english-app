# 非機能要件 & LLMプロンプト仕様

## 14. 非機能要件

### 14.1 パフォーマンス要件

| 項目 | 目標値 |
|------|--------|
| 初回ページロード（LCP） | < 2.5秒 |
| インタラクション応答（FID） | < 100ms |
| レイアウトシフト（CLS） | < 0.1 |
| API応答時間（通常） | < 500ms |
| API応答時間（LLM生成） | < 10秒 |
| 同時接続ユーザー | 1,000人 |
| データベースクエリ | < 100ms |

### 14.2 可用性・信頼性

| 項目 | 目標値 |
|------|--------|
| サービス稼働率 | 99.5% |
| 計画メンテナンス | 月1回、深夜2時間以内 |
| データバックアップ | 日次自動 |
| 障害復旧目標（RTO） | 4時間以内 |
| データ損失許容（RPO） | 24時間以内 |

### 14.3 セキュリティ要件

| カテゴリ | 要件 |
|---------|------|
| 認証 | Supabase Auth（JWT） |
| 通信 | HTTPS必須（TLS 1.3） |
| パスワード | bcrypt ハッシュ化 |
| セッション | 7日間有効、リフレッシュトークン |
| CORS | 許可オリジン限定 |
| レートリミット | 100 req/min/user |
| XSS対策 | 入力サニタイズ、CSP設定 |
| CSRF対策 | SameSite Cookie |

### 14.4 データプライバシー

| 項目 | 対応 |
|------|------|
| 日記データ | ユーザー本人のみアクセス可（RLS） |
| 音声データ | 一時利用後削除（保存オプション有） |
| 個人情報 | 最小限収集、明示的同意取得 |
| データ削除 | アカウント削除時に全データ削除 |
| ログ | 個人情報マスキング |

### 14.5 スケーラビリティ

| 項目 | 戦略 |
|------|------|
| フロントエンド | Vercel Edge Functions |
| データベース | Supabase自動スケーリング |
| LLM API | レートリミット＋キュー処理 |
| 静的アセット | CDN配信 |
| キャッシュ | Redis（将来） |

---

## 15. LLMプロンプト仕様

### 15.1 日記シーン分割プロンプト

```
あなたは日本語の日記を分析するアシスタントです。

【タスク】
ユーザーの日記を読み、状況が変わるごとに2〜5つのシーンに分割してください。

【入力】
日記テキスト: {diaryTextJa}

【出力形式】
以下のJSON形式で出力してください：

{
  "scenes": [
    {
      "sceneId": "scene_1",
      "sceneSummaryJa": "シーンの要約（20-30文字）",
      "originalExcerptJa": "対応する日記の部分",
      "emotion": "anxiety|joy|sadness|anger|surprise|fear|mixed",
      "relationship": "friend|family|coworker|stranger|self|romantic",
      "place": "場所の簡潔な説明"
    }
  ]
}

【ルール】
1. シーンは時間や状況の変化で区切る
2. 感情は最も強いものを1つ選ぶ
3. 関係性は登場人物で最も重要なものを選ぶ
4. 日記に明示されていない情報は推測しない
```

### 15.2 フレーズ提案プロンプト

```
あなたは英会話教師です。日本人学習者に自然な英語フレーズを教えます。

【タスク】
与えられたシーンに適した英会話フレーズを3〜5個提案してください。

【シーン情報】
- 要約: {sceneSummaryJa}
- 感情: {emotion}
- 関係性: {relationship}
- 場所: {place}

【出力形式】
{
  "phrases": [
    {
      "id": "一意のID",
      "textEn": "自然な英語フレーズ",
      "explanationJa": "どんな気持ちで使う表現か（30-50文字）",
      "tone": "casual|polite|playful|serious"
    }
  ]
}

【ルール】
1. 日常会話で実際に使われる自然な表現のみ
2. 直訳ではなく、ネイティブが使う表現
3. 文語や堅すぎる表現は避ける
4. 感情やニュアンスが伝わる説明を付ける
5. 初級〜中級者が理解できるレベル
```

### 15.3 ストーリーテーマ生成プロンプト

```
あなたは創作小説ライターです。英語表現を文脈の中で学ぶためのシーンテーマを考えます。

【タスク】
指定された英語表現が自然に使われる場面を4〜6個提案してください。

【入力】
- ターゲット表現: {targetExpression}
- 補足情報: {supplement}

【出力形式】
{
  "themes": [
    {
      "id": "theme_1",
      "title": "テーマタイトル（日本語、10-15文字）",
      "oneLineJa": "1行説明（20-30文字）",
      "genre": "romance|friendship|work|family|daily|adventure",
      "emotion": "主な感情",
      "relationship": "登場人物の関係性"
    }
  ]
}

【ルール】
1. 多様なジャンルを含める
2. 日常的で共感しやすいシーンを優先
3. 感情の種類を分散させる（不安、喜び、複雑など）
4. 10-30代の日本人学習者が共感できる設定
```

### 15.4 小説シーン生成プロンプト

```
あなたは短編小説ライターです。英語学習者のために印象的なシーンを書きます。

【タスク】
指定されたテーマで、ターゲット表現を自然に含む短編シーンを書いてください。

【入力】
- ターゲット表現: {targetExpression}
- テーマ: {selectedTheme}

【出力形式】
{
  "storyTextEn": "英語のストーリー（180-260 words）",
  "lineExcerpt": "ターゲット表現を含むセリフ（そのまま抜粋）",
  "sceneSummaryJa": "シーン要約（日本語、30-40文字）",
  "nuanceNoteJa": "この文脈でのニュアンス解説（50-80文字）",
  "tags": {
    "genre": "ジャンル",
    "emotion": "主な感情",
    "relationship": "関係性",
    "tone": "全体のトーン"
  }
}

【ストーリー構成】
1. 情景描写（場所、時間、雰囲気）
2. 心理描写（主人公の内面）
3. 会話文（ターゲット表現を自然に含む）
4. 締めの一文（余韻を残す）

【ルール】
1. 明確で読みやすい英語（CEFR B1-B2レベル）
2. ターゲット表現は必ず1回、自然な形で使用
3. 日本人学習者が共感できる設定
4. 感情が伝わる描写を心がける
5. 映画のワンシーンのような臨場感
```

### 15.5 スラング判定プロンプト

```
あなたは英語スラングの専門家です。ネット上で見つかった表現を分析します。

【タスク】
与えられた表現がスラングかどうか判定し、スラングの場合は詳細情報を提供してください。

【入力】
- 表現: {phrase}
- 使用例: {examples}

【出力形式】
{
  "isSlang": true/false,
  "phrase": "表現",
  "readingHintJa": "カタカナ読み",
  "meaningJa": "意味（日本語、50-80文字）",
  "nuanceJa": "ニュアンス解説（80-120文字）",
  "exampleEn": "代表的な例文",
  "exampleJa": "例文の意訳",
  "tone": "casual|rude|wholesome|internet|playful",
  "riskLevel": "safe|careful|avoid",
  "tags": ["タグ1", "タグ2"],
  "region": "US|UK|global|internet"
}

【リスクレベル基準】
- safe: 誰にでも使える
- careful: 場面を選ぶ、親しい間柄向け
- avoid: 不快に感じる人がいる可能性
```

---

## 16. エラーハンドリング

### 16.1 エラーコード

| コード | 説明 | ユーザー向けメッセージ |
|--------|------|----------------------|
| AUTH_001 | 認証失敗 | メールアドレスまたはパスワードが正しくありません |
| AUTH_002 | セッション切れ | セッションが切れました。再ログインしてください |
| AUTH_003 | メール未確認 | メールアドレスの確認が完了していません |
| API_001 | レートリミット超過 | リクエストが多すぎます。しばらくお待ちください |
| API_002 | 無効なリクエスト | 入力内容を確認してください |
| LLM_001 | 生成タイムアウト | 生成に時間がかかっています。再試行してください |
| LLM_002 | 生成失敗 | 生成に失敗しました。再試行してください |
| DB_001 | 保存失敗 | 保存に失敗しました。再試行してください |
| AUDIO_001 | 録音失敗 | マイクへのアクセスを許可してください |
| AUDIO_002 | 音声認識失敗 | 音声を認識できませんでした |

### 16.2 リトライ戦略

| エラー種別 | リトライ | 回数 | 間隔 |
|-----------|---------|------|------|
| ネットワーク | 自動 | 3回 | 指数バックオフ |
| LLM生成 | 手動 | 無制限 | - |
| 認証 | なし | - | - |
| バリデーション | なし | - | - |
